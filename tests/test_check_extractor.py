from pathlib import Path
from unittest.mock import MagicMock, call, ANY

import pytest

from money.check_extractor import get_check, CheckResponce, Status


class TestCheckExtractor:
    @pytest.fixture
    def fakes(self, mocker) -> MagicMock:
        open_mock: MagicMock = mocker.patch("money.check_extractor.open")

        post_mock: MagicMock = mocker.patch("requests.post")

        manager = MagicMock()
        manager.attach_mock(open_mock, "open")
        manager.attach_mock(post_mock, "post")
        return manager

    def test_check_extractor_success(self, fakes, datadir):
        response = MagicMock()
        response.text = r'{"code":1,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}'  # noqa: E501
        response.status_code = 200
        fakes.post.return_value = response

        result = get_check("secret-token", Path("qrfile.jpg"), Path("output.json"))

        assert result == CheckResponce(
            Status.Success,
            r'{"code":1,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}',  # noqa: E501
            200,
        )

        assert fakes.mock_calls == [
            call.open(Path("qrfile.jpg"), "rb"),
            call.post(
                "https://proverkacheka.com/api/v1/check/get", data={"token": "secret-token"}, files={"qrfile": ANY}
            ),
            call.open(Path("output.json"), "w"),
            call.open().__enter__(),
            call.open().__enter__().write(open(datadir / "test_check_extractor_success/1.json").read()),
            call.open().__exit__(None, None, None),
        ]

    def test_check_extractor_not_correct(self, fakes):
        response = MagicMock()
        response.text = r'{"code":0,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}'  # noqa: E501
        response.status_code = 200
        fakes.post.return_value = response

        result = get_check("secret-token", Path("qrfile.jpg"), Path("output.json"))

        assert result == CheckResponce(
            Status.NotCorrect,
            r'{"code":0,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}',  # noqa: E501
            200,
            "Чек некорректен",
        )

    def test_check_extractor_no_data(self, fakes):
        response = MagicMock()
        response.text = r'{"code":2,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}'  # noqa: E501
        response.status_code = 200
        fakes.post.return_value = response

        result = get_check("secret-token", Path("qrfile.jpg"), Path("output.json"))

        assert result == CheckResponce(
            Status.NoData,
            r'{"code":2,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}',  # noqa: E501
            200,
            "Данные чека пока не получены",
        )

    def test_check_extractor_requests_exceeded(self, fakes):
        response = MagicMock()
        response.text = r'{"code":3,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}'  # noqa: E501
        response.status_code = 200
        fakes.post.return_value = response

        result = get_check("secret-token", Path("qrfile.jpg"), Path("output.json"))

        assert result == CheckResponce(
            Status.RequestsExceeded,
            r'{"code":3,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}',  # noqa: E501
            200,
            "Превышено кол-во запросов",
        )

    def test_check_extractor_waiting_before_retry(self, fakes):
        response = MagicMock()
        response.text = r'{"code":4,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}'  # noqa: E501
        response.status_code = 200
        fakes.post.return_value = response

        result = get_check("secret-token", Path("qrfile.jpg"), Path("output.json"))

        assert result == CheckResponce(
            Status.WaitingBeforeRetrying,
            r'{"code":4,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}',  # noqa: E501
            200,
            "Ожидание перед повторным запросом",
        )

    def test_check_extractor_other(self, fakes):
        response = MagicMock()
        response.text = r'{"code":5,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}'  # noqa: E501
        response.status_code = 200
        fakes.post.return_value = response

        result = get_check("secret-token", Path("qrfile.jpg"), Path("output.json"))

        assert result == CheckResponce(
            Status.Other,
            r'{"code":5,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}',  # noqa: E501
            200,
            "Прочее (данные не получены)",
        )

    def test_check_extractor_error(self, fakes):
        response = MagicMock()
        response.text = r'{"code":1,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}'  # noqa: E501
        response.status_code = 404
        fakes.post.return_value = response

        result = get_check("secret-token", Path("qrfile.jpg"), Path("output.json"))

        assert result == CheckResponce(
            Status.Error,
            r'{"code":1,"first":0,"data":{"json":{"code":3,"user":"ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"","items":[{"nds":2,"sum":19439,"name":"Дск Яблоко красное 1кг","price":15999,"quantity":1.215,"paymentType":4,"productType":1,"itemsQuantityMeasure":11},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":7999,"name":"ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л","price":7999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607036340658","sernum":"","productIdType":3,"rawProductCode":"4607036340658"}},"itemsQuantityMeasure":0},{"nds":2,"sum":5999,"name":"*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г","price":5999,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4604386012273","sernum":"","productIdType":3,"rawProductCode":"4604386012273"}},"itemsQuantityMeasure":0},{"nds":1,"sum":9499,"name":"Вафли ЯШКИНСКИЕ ореховые   300г","price":9499,"quantity":1,"paymentType":4,"productType":1,"productCodeNew":{"ean13":{"gtin":"4607015232646","sernum":"","productIdType":3,"rawProductCode":"4607015232646"}},"itemsQuantityMeasure":0}],"nds10":3766,"nds18":1583,"region":"74","userInn":"7825706086  ","dateTime":"2022-08-16T19:11:00","kktRegId":"0004000518016307    ","metadata":{"id":4373135767659163393,"ofdId":"ofd22","address":"454100,Россия,Челябинская область,Челябинский г.о.,Курчатовский г.п.,Челябинск г,,Новоградский пр-кт,,д. 58,,,,","subtype":"receipt","receiveDate":"2022-08-16T17:13:18Z"},"operator":"Котова Анна Романовна, Продавец-каccир","totalSum":50935,"creditSum":0,"numberKkt":"00105702181010","fiscalSign":147824925,"prepaidSum":0,"retailPlace":"385H; 18300 - Пятерочка;","shiftNumber":302,"cashTotalSum":0,"provisionSum":0,"ecashTotalSum":50935,"operationType":1,"redefine_mask":2,"requestNumber":408,"fiscalDriveNumber":"9960440301310853","messageFiscalSign":9.29735071111385e+18,"retailPlaceAddress":"454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;","appliedTaxationType":1,"fiscalDocumentNumber":77916,"fiscalDocumentFormatVer":4},"html":"<table class=\"b-check_table table\"><tbody><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ОБЩЕСТВО С ОГРАНИЧЕННОЙ ОТВЕТСТВЕННОСТЬЮ \"АГРОТОРГ\"<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">454000, 74, г.Челябинск, р-н Курчатовский, пр-кт Новоградский, 58;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">ИНН 7825706086  <\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">&nbsp;<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">16.08.2022 19:11<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Чек № 408<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Смена № 302<\/td><\/tr><tr class=\"b-check_vblock-middle b-check_center\"><td colspan=\"5\">Кассир Котова Анна Романовна, Продавец-каccир<\/td><\/tr><tr class=\"b-check_vblock-last b-check_center\"><td colspan=\"5\">Приход<\/td><\/tr><tr><td><strong>№<\/strong><\/td><td><strong>Название<\/strong><\/td><td><strong>Цена<\/strong><\/td><td><strong>Кол.<\/strong><\/td><td><strong>Сумма<\/strong><\/td><\/tr><tr class=\"b-check_item\"><td>1<\/td><td>Дск Яблоко красное 1кг<\/td><td>159.99<\/td><td>1.215<\/td><td>194.39<\/td><\/tr><tr class=\"b-check_item\"><td>2<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>3<\/td><td>ЧЕБАРКУЛЬ Мол.ОТБ.3,8% м\/у 1л<\/td><td>79.99<\/td><td>1<\/td><td>79.99<\/td><\/tr><tr class=\"b-check_item\"><td>4<\/td><td>*ШАР.Ваф.ВЕН.со взб.сл\/виш.150г<\/td><td>59.99<\/td><td>1<\/td><td>59.99<\/td><\/tr><tr class=\"b-check_item\"><td>5<\/td><td>Вафли ЯШКИНСКИЕ ореховые   300г<\/td><td>94.99<\/td><td>1<\/td><td>94.99<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"3\" class=\"b-check_itogo\">ИТОГО:<\/td><td><\/td><td class=\"b-check_itogo\">509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Наличные<\/td><td><\/td><td>0.00<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">Карта<\/td><td><\/td><td>509.35<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 20%<\/td><td><\/td><td>15.83<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"3\">НДС итога чека со ставкой 10%<\/td><td><\/td><td>37.66<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\">ВИД НАЛОГООБЛОЖЕНИЯ: ОСН<\/td><\/tr><tr class=\"b-check_vblock-first\"><td colspan=\"5\">РЕГ.НОМЕР ККТ: 0004000518016307    <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ЗАВОД. №: <\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФН: 9960440301310853<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФД: 77916<\/td><\/tr><tr class=\"b-check_vblock-middle\"><td colspan=\"5\">ФПД#: 147824925<\/td><\/tr><tr class=\"b-check_vblock-last\"><td colspan=\"5\" class=\"b-check_center\"><img src=\"\/qrcode\/generate?text=t%3D20220816T1911%26s%3D509.35%26fn%3D9960440301310853%26i%3D77916%26fp%3D147824925%26n%3D1\" alt=\"QR код чека\" width=\"35%\" loading=\"lazy\" decoding=\"async\"><\/td><\/tr><\/tbody><\/table>"}}',  # noqa: E501
            404,
        )
